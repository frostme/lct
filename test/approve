#!/usr/bin/env bash
tmpdir="$(mktemp -d)"
tmpdir_escaped=$(printf '%s\n' "$tmpdir" | sed 's/[]\/$*.^|[]/\\&/g')
cli="../target/build/lct"
cli="$(cd "$(dirname "$0")/.." && pwd)/target/build/lct"
mkdir -p "$tmpdir/.config" "$tmpdir/.local/share" "$tmpdir/.local/state" "$tmpdir/.cache"
export HOME="$tmpdir"
export EDITOR="nvim"
export CONFIG_DIR="$tmpdir/.config"
export SHARE_DIR="$tmpdir/.local/share"
export STATE_DIR="$tmpdir/.local/state"
export CACHE_DIR="$tmpdir/.cache"
export LCT_GITHUB_BASE="file://${tmpdir}/mock-github"

trap 'rm -rf "$tmpdir"' EXIT

source test/approvals.bash

cd ./test || exit
export APPROVALS_DIR="$(pwd)/approvals"

describe "help text"
approve "${cli} --help" "help_text"

describe "dotfiles command"
it "adds a dotfile"
approve "${cli} dotfiles add \"$tmpdir/.zshrc\"" "dotfiles_add"
approve "${cli} dotfiles list" "dotfiles_list_after_add"
it "removes a dotfile"
approve "${cli} dotfiles remove \"$tmpdir/.zshrc\"" "dotfiles_remove"
approve "${cli} dotfiles list" "dotfiles_list_after_remove"

describe "configs command"
it "adds a config directory"
approve "${cli} configs add \"$tmpdir/.config/alacritty\"" "configs_add"
approve "${cli} configs list" "configs_list_after_add"
it "removes a config directory"
approve "${cli} configs remove \"$tmpdir/.config/alacritty\"" "configs_remove"
approve "${cli} configs list" "configs_list_after_remove"

describe "install command"
mock_repo_root="$tmpdir/mock-github/example/demo"
mkdir -p "$mock_repo_root"
git -C "$mock_repo_root" init -q
git -C "$mock_repo_root" config user.email "test@example.com"
git -C "$mock_repo_root" config user.name "Test User"
cat >"$mock_repo_root/demo" <<'EOF'
#!/usr/bin/env bash
echo "demo module"
EOF
chmod +x "$mock_repo_root/demo"
git -C "$mock_repo_root" add demo
git -C "$mock_repo_root" commit -q -m "initial"
git -C "$mock_repo_root" tag v1.0.0
cat >"$mock_repo_root/demo" <<'EOF'
#!/usr/bin/env bash
echo "demo module v1.1"
EOF
git -C "$mock_repo_root" add demo
git -C "$mock_repo_root" commit -q -m "second"
git -C "$mock_repo_root" tag v1.1.0
approve "${cli} install example/demo" "install_module"
approve "${cli} install example/demo" "install_module_idempotent"
approve "${cli} install" "install_without_modules"
describe "install via LCTFile"
project_dir="$tmpdir/project"
mkdir -p "$project_dir"
cat >"$project_dir/LCTFile" <<'EOF'
example/demo = 'v1.0.0'
example/demo
EOF
pushd "$project_dir" >/dev/null
approve "${cli} install" "install_from_lctfile"
approve "${cli} install" "install_from_lctfile_idempotent"
popd >/dev/null

describe "prune command"
mkdir -p "$tmpdir/.cache/lct/plugins/acme/tool"
it "lists cache directories in dry run mode"
approve "${cli} prune --cache --dry | sed 's/${tmpdir_escaped}/~/g'" "prune_cache_dry_run_lists_cache_dirs"
